---
title: "Tipología y ciclo de vida de los datos" 
subtitle: "Práctica 2 – Limpieza y análisis de datos"
author: 
- "Francisco de Borja Navas Torres"
- "Álvaro de la Fuente Díaz"
date: "Junio 2021"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
  pdf_document:
    toc: yes
    toc_depth: '2'
---


```{r load_libraries, include=FALSE}
library(dplyr)
```

******
# Introducción
******

En esta segunda práctica de la asignatura de Tipología y ciclo de vida de los datos, vamos a tratar de limpiar y analizar los datos contenidos en el dataset 'titanic.csv'. Este dataset contiene información sobre sobre los pasajeros que abordaron en el titanic desde los diferentes puertos en los que atracó.


******
# Descripción del dataset. ¿Por qué es importante y qué pregunta/problema pretende responder?
******

El dataset elegido comprende información sobre el naufragio del Titanic, que nos permite conocer según una serie de características de los pasajeros que veremos a continuación si sobrevivió o no al accidente. El dataset costa de 891 ocurrencias para un total de 12 variables y lo hemos obtenido de la web de kaggle (https://www.kaggle.com/c/titanic).

Las variables contenidas en el dataset son las siguientes:

* PassengerId: identificador numérico del pasajero que embarcó en el Titanic
* Survived: Indicador de si el pasajero sobrevivió al accidente del Titanic. 
  + El valor “0” se corresponde con que “No” sobrevivió.
  + El valor “1” corresponde con que “Sí” sobrevivió.
* Pclass: Indicador del tipo de billete del pasajero. 
  + 1 = Primera clase
  + 2 = Segunda clase
  + 3 = Tercera clase
* Name: nombre del pasajero, con el formato “Apellido, Nombre”
* Sex: sexo del pasajero. Los posibles valores son “male” y “female”.
* Age: edad del pasajero.
* SibSp: número de hermanos/cónyuge del pasajero a bordo.
* Parch: número de padres/hijos del pasajero a bordo.
* Ticket: identificador del billete.
* Fare: precio del billete
* Cabin: identificador del camarote del pasajero.
* Embarked: puerto en el que embarcó el pasajero:
  + C = Cherbourg
  + Q = Queenstown
  + S = Southampton

El problema que tenemos como objetivo dar solución mediante el análisis de este dataset es ver qué variables del dataset tienen mayor influencia sobre el evento de supervivencia del pasajero durante el conocido accidente del crucero Titanic. Con esta solución, podremos crear modelos predictivos que nos permitan conocer dependiendo de las características de un hipotético pasajero cuál es la probabilidad de que hubiese sobrevivido al accidente. Esta información no sólo es interesante desde un punto de vista “curioso” sobre este accidente que ocurrió años atrás, sino que desde el punto de vista proyectivo puede ayudar al conocimiento de ingenieros navales para mejorar en el diseño y construcción de grandes transatlánticos que sean más seguros en accidentes de índole similar como alcances de grandes objetos sobre buques.



******
# Integración y selección de los datos de interés a analizar
******

Desde el punto de vista de la integración nos hemos encontrado que en la fuente tenemos separado en dos ficheros independientes este dataset (uno para entrenamiento y otro para set), ya que está preparado para la ejecución de modelos. Por tanto, como primer paso y con el objetivo de disponer de la totalidad de muestras para el análisis que estamos realizando, hemos realizado una concatenación de las ocurrencias de ambos datasets.

Desde el punto de vista de la selección descartamos aplicar cualquier técnica de filtrado porque nos interesa realizar el análisis sobre el conjunto entero de ocurrencias, sin discriminar cualquier tipo de muestra dentro del dataset. Por otro lado, no disponemos de ninguna variable que proceda de algún cálculo sobre otras, ni vemos relevante poder realizar cálculo alguno sobre más de una variable del dataset para intentar reducir el número de atributos sin que afecte en la representatividad de todas las variables en conjunto.

Basado en el análisis del total de atributos, si que vemos relevante descartar las variables PassengerId, Name y Ticket, puesto que son identificadores o descriptivos propios de cada uno de los pasajeros pero que no nos van a ayudar al análisis que nos compete puesto que el valor de cada uno de estos atributos no presenta ningún tipo de agrupación sobre todos los demás.

Por último, vamos a realizar un análisis sobre al correlación que existe entre todo el monto resultante de variables con el objetivo de descartar algunas de ellas en el caso de que nos encontremos con un elevado índice de correlación.


¿Borrar campo Cabin?


******
# Limpieza de los datos
******

En primer lugar, para poder realizar cualquier análisis sobre el dataset 'Titanic', es necesario hacer la carga de los datos. Para ello, vamos a cargar el conjunto de datos almacenado en el fichero 'titanic_all.csv' y comprobar que R interpreta correctamente los tipos de los datos.

```{r, echo=TRUE}
# Cargamos el fichero de datos
titanic_data <- read.csv('../data/titanic_train.csv',stringsAsFactors = FALSE)

# Primeros registros del dataset
head(titanic_data)

# Verificamos la estructura del conjunto de datos
str(titanic_data)

#Estadísticas básicas
summary(titanic_data)
```

Podemos ver que el dataset está compuesto por 1309 registros y 12 variables. En el apartado anterior, vimos que los atributos 'PassengerId', 'Name' y 'Ticket' no son relevantes de cara a nuestro estudio por lo que vamos a eliminarlos de la muestra.

```{r, echo=TRUE}
# Seleccionamos las variables relevantes
titanic_data <- titanic_data[c('Survived', 'Pclass', 'Sex', 'Age', 'SibSp', 'Parch', 'Fare', 'Cabin', 'Embarked')]
str(titanic_data)
```


## Elementos vacíos

El primer paso del proceso de limpieza de los datos es el de detectar y corregir los posibles elementos vacíos. De esta forma nos aseguraremos que todos los registros del dataset están informados.

```{r, echo=TRUE}
# Valores perdidos
colSums(is.na(titanic_data))
colSums(titanic_data=="")
```

Vemos que existen valores perdidos en los atributos 'Age' y 'Embarked'. Para corregir la variable referente a la edad de los pasajeros, vamos a imputar los valores perdidos con la edad media de los valores presentes en la muestra. Los valores vacíos de la variable 'Embarked' los vamos a informar con el carácter 'U' referente a 'Unknown'.

```{r, echo=TRUE}
# Sustituimos los valores vacíos de la variable 'Age' por la media
titanic_data$Age[is.na(titanic_data$Age)] <- mean(titanic_data$Age,na.rm=T)

# Sustituimos los valores vacíos de la variable 'Embarked' por el valor U (unknown)
titanic_data$Embarked[titanic_data$Embarked==""]="U"
```

Comprobamos que se han corregido los valores perdidos.

```{r, echo=TRUE}
# Valores perdidos
colSums(is.na(titanic_data))
colSums(titanic_data=="")
```

## Valores extremos

Después de corregir los valores perdidos, vamos a analizar la posible existencia de valores extremos dentro del conjunto de la muestra. De entre los atributos del conjunto de los datos, solamente 'Age' y 'Fare' podrían tener valores extremos ya que son las únicas variables numéricas. 

```{r,eval=TRUE,echo=TRUE}
# Realizamos un diagrama de caja para comprobar si existen valores atípicos dentro de la variable 'Fare'
boxplot(titanic_data$"Fare",main="Box plot", col="gray")
```

Vemos que existe al menos un valor que excede notablemente al resto con un valor superior a 500. En el otro extremo, existe algún pasajero que no pagó por embarcarse en el Titanic. Esto valor podría ser un valor centinela, asociado a casos excepcionales en los que por desconocimiento se inserta algún valor atípico. Estos valores extremos, pueden tener un impacto significativo a la hora de realizar el análisis de los datos por lo que vamos a imputarlos. Vamos a reemplazar estos valores por la media del resto de precios pagados por los pasajeros.

```{r,eval=TRUE,echo=TRUE}
# Reemplazamos los valores extremo en la variable 'Fare' por la media del resto
mean_fare <- mean(titanic_data$Fare[(titanic_data$Fare < 500) & (titanic_data$Fare != 0)])
titanic_data$Fare[titanic_data$Fare > 500] <- mean_fare
titanic_data$Fare[titanic_data$Fare == 0] <- mean_fare
```

Una vez hemos corregido los valores extremos de la variable 'Fare', vamos a analizar la existencia de estos valores anómalos dentro del atributo 'Age'.

```{r,eval=TRUE,echo=TRUE}
# Realizamos un diagrama de caja para comprobar si existen valores atípicos dentro de la variable 'Age'
boxplot(titanic_data$"Age",main="Box plot", col="gray")
```

Tal como podemos ver en el diagrama de caja anterior, no existen valores extremos. La edad mínima es un valor muy cercano a 0, lo que significa que en el transatlántico viajaba algún bebe mientras que la edad del pasajero más anciano era de 80 años.

Por último, una vez que hemos imputado los valores perdidos y hemos eliminado los valores extremos que pudieran falsear los resultados obtenidos, vamos a convertir las variables a categóricas para facilitar los análisis posteriores.

```{r,eval=TRUE,echo=TRUE}
# Convertimos la variable 'Sex' a categórica
titanic_data$Sex <- as.factor(titanic_data$Sex)

# Convertimos la variable 'Survived' a categórica
titanic_data$Survived <- as.factor(titanic_data$Survived)

# Convertimos la variable 'Pclass' a categórica
titanic_data$Pclass <- as.factor(titanic_data$Pclass)

# Convertimos la variable 'SibSp' a categórica
titanic_data$SibSp <- as.factor(titanic_data$SibSp)

# Convertimos la variable 'Parch' a categórica
titanic_data$Parch <- as.factor(titanic_data$Parch)

# Convertimos la variable 'Embarked' a categórica
titanic_data$Embarked <- as.factor(titanic_data$Embarked)
```

Extraemos unas estadísticas básicas del dataset para comprobar que todos los cambios se han realizado correctamente y que todas las variables tienen el tipo de dato correcto.

```{r,eval=TRUE,echo=TRUE}
#Estadísticas básicas
summary(titanic_data)
```

******
# Análisis de los datos
******

## Selección de los grupos de datos a analizar

En este apartado vamos a seleccionar los grupos de datos presentes en el dataset, que vamos a utilizar durante el análisis posterior.

De entro de todos campos, vamos a seleccionar los atributos referentes al sexo del pasajero, la clase en la que viajaban, el puerto en el que embarcaron y si consiguieron sobrevivir al accidente.

```{r,eval=TRUE,echo=TRUE}
# Agrupación por sexo
titanic_data.female <- titanic_data[titanic_data$Sex == 'female',]
titanic_data.male <- titanic_data[titanic_data$Sex == 'male',]

# Agrupación por clase
titanic_data.class_1 <- titanic_data[titanic_data$Pclase == '1',]
titanic_data.class_2 <- titanic_data[titanic_data$Pclass == '2',]
titanic_data.class_3 <- titanic_data[titanic_data$Pclass == '3',]

# Agrupación por supervivencia
titanic_data.survived_no <- titanic_data[titanic_data$Survived == '0',]
titanic_data.survived_yes <- titanic_data[titanic_data$Survived == '1',]

# Agrupación por el puerto de embarque
titanic_data.embarked_c <- titanic_data[titanic_data$Embarked == 'C',]
titanic_data.embarked_q <- titanic_data[titanic_data$Embarked == 'Q',]
titanic_data.embarked_s <- titanic_data[titanic_data$Embarked == 'S',]
titanic_data.embarked_u <- titanic_data[titanic_data$Embarked == 'U',]
```



## Comprobación de la normalidad y homogeneidad de la varianza 

Vamos a comprobar la normalidad de las variables cuantitativas presentes en la muestra. Para ello, vamos a emplear la prueba de normalidad de Anderson-Darling. Vamos a definir un valor alfa de 0,05 de manera que si el p-valor obtenido para cada variable en el análisis es superior al valor de alfa, podemos afirmar que esta variable sigue una distribución normal.

```{r,eval=TRUE,echo=TRUE}
library(nortest)

alpha = 0.05
col.names = colnames(titanic_data)

for (i in 1:ncol(titanic_data)) {
  if (i == 1) cat("Variables que no siguen una distribución normal:\n")
  if (is.integer(titanic_data[,i]) | is.numeric(titanic_data[,i])) {
    p_val = ad.test(titanic_data[,i])$p.value
    if (p_val < alpha) {
      cat(col.names[i])
      cat(": p-valor ")
      cat(p_val)
      cat("\n")
    }
  }
}
```

Podemos ver como las variables Age y Fare tiene un p-valor de 3.7e-24. Este valor es muy inferior al valor alfa definido previamente por lo que podemos afirmar que no siguen una distribución normal.

Depués de haber analizado la normalidad de las variables, vamos a estudiar la homogeneidad de la varianza a través del método Fligner-Killeen. Para ello, vamos a realizar las siguientes pruebas:

* Estudio de la homogeneidad del precio del billete en función del sexo del pasajero. Para ello, vamos a establecer la hipótesis nula de que ambas varianzas son iguales.

```{r,eval=TRUE,echo=TRUE}
# Estudio de la homogeneidad del precio del billete en función del sexo del pasajero
fligner.test(Fare ~ Sex, data=titanic_data)
```

El resultado del test da un p-valor de 3.663e-12. Este valor es es muy inferior a 0.05 por lo que rechazamos la hipótesis nula confirmando que ambas varianzas son diferentes.

* Estudio de la homogeneidad del precio del billete en función de si el pasajero sovrevivió al accidente. Para ello, vamos a establecer la hipótesis nula de que ambas varianzas son iguales.

```{r,eval=TRUE,echo=TRUE}
# Estudio de la homogeneidad del precio del billete en función de si el pasajero sovrevivió al accidente
fligner.test(Fare ~ Survived, data=titanic_data)
```

El p-valor obtenido al realizar el test es menor que 2.2e-16, por lo que al ser menor que 0.05 rechazamos la hipótesis nula. Es decir, las varianzas de ambos campos no son iguales.

* Estudio de la homogeneidad de la edad del pasajero en función de la clase en la que viajaba. Para ello, vamos a establecer la hipótesis nula de que ambas varianzas son iguales.

```{r,eval=TRUE,echo=TRUE}
# Estudio de la homogeneidad de la edad del pasajero en función de la clase
fligner.test(Age ~ Pclass, data=titanic_data)
```

El resultado del test es un p-valor igual a 2.55e-08. Dado que este valor es inferior a 0.05, podemos afirmar que la hipótesis nula no es correcta confirmando que la varianza de las dos variables no son iguales.

* Estudio de la homogeneidad de la edad del pasajero en función de su sexo. Para ello, vamos a establecer la hipótesis nula de que ambas varianzas son iguales.

```{r,eval=TRUE,echo=TRUE}
# Estudio de la homogeneidad de la edad del pasajero en función de su sexo
fligner.test(Age ~ Sex, data=titanic_data)
```

En este caso, el resultado del test es un p-valor de 0.305. Al tratarse de un valor superior a 0.05 podemos afirmar que la hipotesis nula es correcta, confirmando que la varianza de ambas variableses igual.

## Análisis estadístico del dataset

### Modelo de regresión lineal



### Contraste de hipótesis

A continuación evaluaremos si la edad o el precio del billete influyen sobre la supervivencia al accidente.

Caso 1: Edad sobre la superviviencia. ¿Tienen mayor probabilidad de superviviencia las personas de menor edad?

```{r,eval=TRUE,echo=TRUE}

t.test(titanic_data.survived_yes$Age,titanic_data.survived_no$Age, 
alternative = "less")
```
Obtenemos un p-valor inferior a nuestro coeficiente de significación del 0.05. Por tanto, rechazamos la hipótesis nula y afirmamos que la probabilidad de supervivencia será mayor cuanto menor sea la edad.

Caso 2: Precio del billete sobre la supervivivencia.¿Tienen mayor probabilidad de superviviencia las personas que gozan de un billete más exclusivo?

```{r,eval=TRUE,echo=TRUE}

t.test(titanic_data.survived_no$Fare,titanic_data.survived_yes$Fare, 
alternative = "less")
```
Obtenemos un p-valor inferior a nuestro coeficiente de significación del 0.05. Por tanto, rechazamos la hipótesis nula y afirmamos que la probabilidad de supervivencia será mayor cuanto mayor coste tenga el billete.


******
# Representación gráfica de los resultados
******
xxxxxxxxxx

******
# Conclusiones
******

xxxxxxxxxxx





